{% extends "peptitions/userPage/main.html" %}
{% load crispy_forms_tags %}

{% block content %}
<main class="flex-1 p-4 md:p-6 overflow-y-auto">

  <!-- Header Section -->
  <div class="mb-6 md:mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
      <div class="mb-4 lg:mb-0">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">My Petitions</h1>
        <p class="text-gray-600 text-sm md:text-base">Manage and track all your created petitions</p>
      </div>
      <div>
        <button id="openFormBtn"
           class="w-full lg:w-auto bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 md:px-6 py-3 rounded-xl md:rounded-2xl font-semibold transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-lg flex items-center justify-center space-x-2">
          <i class="fas fa-plus"></i>
          <span>Create New Petition</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Overview - Mobile Stacked -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-6 md:mb-8">
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xl md:text-2xl font-bold mb-1">{{ total_petitions|default:"0" }}</p>
          <p class="text-blue-100 text-xs md:text-sm font-medium">Total</p>
        </div>
        <i class="fas fa-scroll text-lg md:text-2xl text-blue-200"></i>
      </div>
    </div>

    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xl md:text-2xl font-bold mb-1">{{ pending_petitions|default:"0" }}</p>
          <p class="text-yellow-100 text-xs md:text-sm font-medium">Pending</p>
        </div>
        <i class="fas fa-clock text-lg md:text-2xl text-yellow-200"></i>
      </div>
    </div>

    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xl md:text-2xl font-bold mb-1">{{ approved_petitions|default:"0" }}</p>
          <p class="text-green-100 text-xs md:text-sm font-medium">Approved</p>
        </div>
        <i class="fas fa-check-circle text-lg md:text-2xl text-green-200"></i>
      </div>
    </div>

    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xl md:text-2xl font-bold mb-1">{{ rejected_petitions|default:"0" }}</p>
          <p class="text-red-100 text-xs md:text-sm font-medium">Rejected</p>
        </div>
        <i class="fas fa-times-circle text-lg md:text-2xl text-red-200"></i>
      </div>
    </div>
  </div>

  <!-- Petitions Table - Mobile Cards / Desktop Table -->
  <div class="bg-white rounded-xl md:rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
    <!-- Table Header -->
    <div class="px-4 md:px-6 py-4 bg-gray-50 border-b border-gray-200">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Your Petition History</h3>
        <div class="flex items-center space-x-4 mt-2 sm:mt-0">
          <span class="text-sm text-gray-600">{{ petitions.count }} petition{{ petitions.count|pluralize }}</span>
          <select class="hidden sm:block text-sm border border-gray-300 rounded-lg px-3 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option>All Status</option>
            <option>Pending</option>
            <option>Approved</option>
            <option>Rejected</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Mobile Card View -->
    <div class="md:hidden">
      {% for petition in petitions %}
      <div class="border-b border-gray-200 p-4">
        <div class="flex justify-between items-start mb-3">
          <div class="flex-1">
            <h4 class="font-medium text-gray-900 text-sm mb-1">{{ petition.title }}</h4>
            <p class="text-gray-500 text-xs mb-2">{{ petition.description|truncatewords:8 }}</p>
          </div>
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
            {% if petition.status == 'pending' %} 
              bg-yellow-100 text-yellow-800
            {% elif petition.status == 'approved' %} 
              bg-green-100 text-green-800
            {% elif petition.status == 'rejected' %} 
              bg-red-100 text-red-800
            {% endif %}">
            {{ petition.status|capfirst }}
          </span>
        </div>
        
        <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
          <span>Created: {{ petition.created_at|date:"M d, Y" }}</span>
          {% if petition.status == "approved" %}
          <span>{{ petition.current_signatures }}/{{ petition.target_signatures }} signs</span>
          {% endif %}
        </div>

        <div class="flex justify-between items-center">
          <div class="flex space-x-2">
            {% if petition.status == "approved" %}
            <a href="#" class="text-blue-600 text-xs font-medium">View</a>
            <a href="#" class="text-blue-600 text-xs font-medium">Share</a>
            {% elif petition.status == "rejected" %}
            <a href="#" 
               onclick="return confirm('Delete this petition?');"
               class="text-red-600 text-xs font-medium">Delete</a>
            {% elif petition.status == "pending" %}
            <a href="#" class="text-blue-600 text-xs font-medium">Edit</a>
            <a href="#" 
               onclick="return confirm('Delete this petition?');"
               class="text-red-600 text-xs font-medium">Delete</a>
            {% endif %}
          </div>
          {% if petition.status == "approved" %}
          <div class="w-20 bg-gray-200 rounded-full h-1.5">
            <div class="bg-green-600 h-1.5 rounded-full" 
                 style="width: {% widthratio petition.current_signatures petition.target_signatures 100 %}%">
            </div>
          </div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div class="p-8 text-center">
        <i class="fas fa-scroll text-gray-300 text-3xl mb-3"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-1">No Petitions Created</h3>
        <p class="text-gray-500 mb-4 text-sm">You haven't created any petitions yet.</p>
        <button id="openFormBtnEmptyMobile"
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center space-x-2 mx-auto">
          <i class="fas fa-plus"></i>
          <span>Create First Petition</span>
        </button>
      </div>
      {% endfor %}
    </div>

    <!-- Desktop Table View -->
    <div class="hidden md:block overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Petition</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Created</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Progress</th>
            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for petition in petitions %}
          <tr class="hover:bg-blue-50 transition-colors duration-150">
            <!-- Petition Title -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-100 to-blue-200 rounded-lg flex items-center justify-center text-blue-600 mr-3">
                  <i class="fas fa-scroll text-sm"></i>
                </div>
                <div>
                  <div class="text-sm font-medium text-gray-900 max-w-xs truncate">
                    {{ petition.title }}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">
                    {{ petition.description|truncatewords:5 }}
                  </div>
                </div>
              </div>
            </td>
            
            <!-- Status -->
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                {% if petition.status == 'pending' %} 
                  bg-yellow-100 text-yellow-800 border border-yellow-200
                {% elif petition.status == 'approved' %} 
                  bg-green-100 text-green-800 border border-green-200
                {% elif petition.status == 'rejected' %} 
                  bg-red-100 text-red-800 border border-red-200
                {% endif %}">
                <i class="fas fa-circle text-xs mr-1 
                  {% if petition.status == 'pending' %}text-yellow-500
                  {% elif petition.status == 'approved' %}text-green-500
                  {% elif petition.status == 'rejected' %}text-red-500
                  {% endif %}">
                </i>
                {{ petition.status|capfirst }}
              </span>
            </td>
            
            <!-- Created Date -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">{{ petition.created_at|date:"M d, Y" }}</div>
              <div class="text-xs text-gray-500">{{ petition.created_at|timesince }} ago</div>
            </td>
            
            <!-- Progress -->
            <td class="px-6 py-4 whitespace-nowrap">
              {% if petition.status == "approved" %}
              <div class="flex items-center space-x-2">
                <div class="w-16 bg-gray-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full" 
                       style="width: {% widthratio petition.current_signatures petition.target_signatures 100 %}%">
                  </div>
                </div>
                <span class="text-sm text-gray-600 font-medium">
                  {{ petition.current_signatures }}/{{ petition.target_signatures }}
                </span>
              </div>
              {% else %}
              <span class="text-sm text-gray-400">â€”</span>
              {% endif %}
            </td>
            
            <!-- Actions -->
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center space-x-2">
                {% if petition.status == "approved" %}
                <a href="#" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                  <i class="fas fa-eye mr-1"></i>
                  View
                </a>
                <a href="#" class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-xs font-medium rounded-lg text-blue-700 bg-blue-50 hover:bg-blue-100 transition-colors duration-200">
                  <i class="fas fa-share mr-1"></i>
                  Share
                </a>
                {% elif petition.status == "rejected" %}
                <a href="#" 
                   onclick="return confirm('Delete this petition?');"
                   class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200">
                  <i class="fas fa-trash mr-1"></i>
                  Delete
                </a>
                {% elif petition.status == "pending" %}
                <a href="#" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200">
                  <i class="fas fa-edit mr-1"></i>
                  Edit
                </a>
                <a href="#" 
                   onclick="return confirm('Delete this petition?');"
                   class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 transition-colors duration-200">
                  <i class="fas fa-trash mr-1"></i>
                  Delete
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center">
                <i class="fas fa-scroll text-gray-300 text-4xl mb-3"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-1">No Petitions Created</h3>
                <p class="text-gray-500 mb-4">You haven't created any petitions yet.</p>
                <button id="openFormBtnEmpty"
                   class="inline-flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                  <i class="fas fa-plus"></i>
                  <span>Create Your First Petition</span>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Table Footer -->
    {% if petitions %}
    <div class="px-4 md:px-6 py-4 bg-gray-50 border-t border-gray-200">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-sm text-gray-600">
        <span class="mb-2 sm:mb-0">Showing {{ petitions.count }} petition{{ petitions.count|pluralize }}</span>
        <div class="flex space-x-2">
          <button class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">Previous</button>
          <button class="px-3 py-1 border border-blue-500 bg-blue-600 text-white rounded-lg text-sm">1</button>
          <button class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm">Next</button>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

</main>

<!-- Enhanced Modal Form - Mobile Responsive -->
<div id="petitionModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-2 md:p-4">
  <div class="bg-white rounded-xl md:rounded-2xl shadow-2xl w-full max-w-2xl max-h-[95vh] md:max-h-[90vh] overflow-y-auto mx-2">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-4 md:p-6 rounded-t-xl md:rounded-t-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl md:text-2xl font-bold">Create New Petition</h2>
          <p class="text-blue-100 mt-1 text-sm md:text-base">Start a movement and gather support</p>
        </div>
        <button id="closeFormBtn"
                class="text-blue-200 hover:text-white text-2xl transition-colors duration-200">
          &times;
        </button>
      </div>
    </div>
    
    <!-- Modal Body -->
    <div class="p-4 md:p-6">
      <form method="POST" enctype="multipart/form-data" class="space-y-4 md:space-y-6">
        {% csrf_token %}
        {{ form|crispy }}

        <div class="flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3 pt-4 border-t border-gray-200">
          <button type="button" id="cancelFormBtn"
                  class="w-full sm:w-auto px-4 md:px-6 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg md:rounded-xl hover:bg-gray-50 transition-all duration-200">
            Cancel
          </button>
          <button type="submit" 
                  class="w-full sm:w-auto px-4 md:px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-lg md:rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-paper-plane"></i>
            <span>Submit Petition</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  const openBtn = document.getElementById("openFormBtn");
  const openBtnEmpty = document.getElementById("openFormBtnEmpty");
  const openBtnEmptyMobile = document.getElementById("openFormBtnEmptyMobile");
  const closeBtn = document.getElementById("closeFormBtn");
  const cancelBtn = document.getElementById("cancelFormBtn");
  const modal = document.getElementById("petitionModal");

  // Open modal
  [openBtn, openBtnEmpty, openBtnEmptyMobile].forEach(btn => {
    if (btn) {
      btn.addEventListener("click", () => modal.classList.remove("hidden"));
    }
  });

  // Close modal
  [closeBtn, cancelBtn].forEach(btn => {
    if (btn) {
      btn.addEventListener("click", () => modal.classList.add("hidden"));
    }
  });

  // Close on outside click
  modal.addEventListener("click", (e) => {
    if (e.target === modal) {
      modal.classList.add("hidden");
    }
  });

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      modal.classList.add('hidden');
    }
  });
</script>
{% endblock %}